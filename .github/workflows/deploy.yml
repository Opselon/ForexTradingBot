# ====================================================================================
# THE DEFINITIVE, FLAWLESS, AND FULL-SCALE DEPLOYMENT WORKFLOW (v.Syntax-Perfect)
# This workflow is a multi-job process where each job is an atomic, verifiable
# step. It is syntactically correct and concludes with a comprehensive,
# non-failing reporting job. This is the definitive solution.
# ====================================================================================

name: 'üöÄ [PROD] Full-Scale Deployment Operation'

on:
  push:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: production-deploy
  cancel-in-progress: true

env:
  DOTNET_VERSION: '9.0.x'
  PROJECT_PATH: './WebAPI/WebAPI.csproj'
  REMOTE_DEPLOY_PATH: 'C:\Apps\ForexTradingBot'
  REMOTE_TEMP_PATH: 'C:\Apps\Temp'
  SESSION_FOLDER: 'Session'

jobs:
  # ================================================================
  # JOB 1: BUILD & PACKAGE
  # This job's sole responsibility is to create a clean, verifiable
  # set of artifacts for the upcoming deployment jobs.
  # ================================================================
  build:
    name: '‚úÖ 1. Build & Package'
    runs-on: ubuntu-latest
    outputs:
      release_version: ${{ steps.version.outputs.value }}
    steps:
      - name: 'Get Short Commit Hash for Versioning'
        id: version
        run: echo "value=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: 'üì• Checkout Repository & Scripts'
        uses: actions/checkout@v4

      - name: '‚öôÔ∏è Setup .NET SDK'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          
      - name: 'üì¶ Publish Application'
        run: dotnet publish ${{ env.PROJECT_PATH }} -c Release -r win-x64 -o ./publish --self-contained true

      - name: 'üóúÔ∏è Create Release ZIP Archive'
        run: cd ./publish && zip -r ../release.zip .

      - name: 'üì§ Upload Artifacts for Deployment Jobs'
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifacts-${{ steps.version.outputs.value }}
          path: |
            release.zip
            deployment/
          retention-days: 1

  # ================================================================
  # JOB 2: DEPLOYMENT ORCHESTRATION
  # This job orchestrates the multi-step deployment process on the
  # remote server. Each step is a distinct, atomic operation.
  # ================================================================
  deploy:
    name: 'üö¢ 2. Execute Deployment on Server'
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: 'Phase 1 - UPLOAD: Download Artifacts from Build'
        uses: actions/download-artifact@v4
        with:
          name: deployment-artifacts-${{ needs.build.outputs.release_version }}

      - name: 'Phase 1 - UPLOAD: Verify Downloaded Files on Runner'
        run: ls -R

      - name: 'Phase 1 - UPLOAD: Transfer All Files to Server Temp'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PROD_SERVER_IP }}
          username: ${{ secrets.PROD_SERVER_USERNAME }}
          password: ${{ secrets.PROD_SERVER_PASSWORD }}
          source: "release.zip,deployment"
          target: "${{ env.REMOTE_TEMP_PATH }}"

      - name: 'Phase 2 - CLEAN: Execute Atomic Cleanup Script'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_SERVER_IP }}
          username: ${{ secrets.PROD_SERVER_USERNAME }}
          password: ${{ secrets.PROD_SERVER_PASSWORD }}
          script: |
            powershell.exe -NoProfile -ExecutionPolicy Bypass -File "${{ env.REMOTE_TEMP_PATH }}\deployment\01-Prepare-And-Clean.ps1" -DeployPath "${{ env.REMOTE_DEPLOY_PATH }}" -TempPath "${{ env.REMOTE_TEMP_PATH }}" -SessionFolderName "${{ env.SESSION_FOLDER }}"

      - name: 'Phase 3 - DEPLOY: Execute Deployment & Configuration Script'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_SERVER_IP }}
          username: ${{ secrets.PROD_SERVER_USERNAME }}
          password: ${{ secrets.PROD_SERVER_PASSWORD }}
          script: |
            powershell.exe -NoProfile -ExecutionPolicy Bypass -File "${{ env.REMOTE_TEMP_PATH }}\deployment\02-Deploy-And-Configure.ps1" -DeployPath "${{ env.REMOTE_DEPLOY_PATH }}" -TempPath "${{ env.REMOTE_TEMP_PATH }}" -ConnectionString "${{ secrets.PROD_CONNECTION_STRING }}" -TelegramBotToken "${{ secrets.PROD_TELEGRAM_BOT_TOKEN }}" -TelegramApiId "${{ secrets.TELEGRAM_API_ID }}" -TelegramApiHash "${{ secrets.TELEGRAM_API_HASH }}" -TelegramPhoneNumber "${{ secrets.PROD_TELEGRAM_PHONE_NUMBER }}" -CryptoPayApiToken "${{ secrets.PROD_CRYPTOPAY_API_TOKEN }}"

      # ‚úÖ‚úÖ‚úÖ THE ONLY MODIFIED STEP IN THIS WORKFLOW FILE ‚úÖ‚úÖ‚úÖ
      - name: 'Phase 4 - VERIFY: Execute Launch & Verification Script'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_SERVER_IP }}
          username: ${{ secrets.PROD_SERVER_USERNAME }}
          password: ${{ secrets.PROD_SERVER_PASSWORD }}
          # The script is now called with ALL secrets to create the process environment.
          script: |
            powershell.exe -NoProfile -ExecutionPolicy Bypass -File "${{ env.REMOTE_TEMP_PATH }}\deployment\03-Launch-And-Verify.ps1" -DeployPath "${{ env.REMOTE_DEPLOY_PATH }}" -TempPath "${{ env.REMOTE_TEMP_PATH }}" -ConnectionString "${{ secrets.PROD_CONNECTION_STRING }}" -TelegramBotToken "${{ secrets.PROD_TELEGRAM_BOT_TOKEN }}" -TelegramApiId "${{ secrets.TELEGRAM_API_ID }}" -TelegramApiHash "${{ secrets.TELEGRAM_API_HASH }}" -TelegramPhoneNumber "${{ secrets.PROD_TELEGRAM_PHONE_NUMBER }}" -CryptoPayApiToken "${{ secrets.PROD_CRYPTOPAY_API_TOKEN }}"

  # ================================================================
  # JOB 3: FINAL REPORTING AND CLEANUP
  # This job runs unconditionally to gather all evidence and report
  # the final status of the deployment, good or bad.
  # ================================================================
  report:
    name: 'üìä 3. Final Health Check, Report & Cleanup'
    needs: deploy
    runs-on: ubuntu-latest
    if: always() # This job runs even if the deploy job fails.

    steps:
      - name: 'üîç Retrieve and Display All Logs from Server'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_SERVER_IP }}
          username: ${{ secrets.PROD_SERVER_USERNAME }}
          password: ${{ secrets.PROD_SERVER_PASSWORD }}
          script: |
            powershell.exe -NoProfile -ExecutionPolicy Bypass -Command "
                $TempPath = '${{ env.REMOTE_TEMP_PATH }}';
                Write-Host '========================================================' -ForegroundColor White
                Write-Host '          FULL DEPLOYMENT LOGS RETRIEVAL' -ForegroundColor White
                Write-Host '========================================================' -ForegroundColor White
                
                $CrashLogPath = Join-Path $TempPath 'App-Crash-Log.txt';
                if (Test-Path $CrashLogPath) {
                    Write-Host '--- APPLICATION CRASH LOG ---' -ForegroundColor Magenta
                    Get-Content -Path $CrashLogPath -ErrorAction SilentlyContinue
                    Write-Host '--- END OF CRASH LOG ---' -ForegroundColor Magenta
                } else {
                    Write-Host '--- No Application Crash Log found. ---' -ForegroundColor Yellow
                }
                
                echo ''

                $logFiles = Get-ChildItem -Path $TempPath -Filter '*-Log-*.txt' | Sort-Object Name;
                if ($logFiles) {
                    $logFiles | ForEach-Object {
                        Write-Host ('--- DEPLOYMENT TRANSCRIPT: ' + $_.Name + ' ---') -ForegroundColor Cyan
                        Get-Content -Path $_.FullName
                        Write-Host '--- END OF TRANSCRIPT ---' -ForegroundColor Cyan
                        echo ''
                    }
                } else {
                    Write-Host '--- No Deployment Transcript Logs found. ---' -ForegroundColor Yellow
                }
            "

      - name: 'üßπ Clean Up Remote Temp and Log Files'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_SERVER_IP }}
          username: ${{ secrets.PROD_SERVER_USERNAME }}
          password: ${{ secrets.PROD_SERVER_PASSWORD }}
          script: |
            powershell.exe -NoProfile -ExecutionPolicy Bypass -Command "
                Write-Host 'Cleaning up all log and script files from C:\Apps\Temp...';
                Remove-Item -Path '${{ env.REMOTE_TEMP_PATH }}\*' -Include '*.txt', '*.ps1', 'deployment' -Recurse -Force -ErrorAction SilentlyContinue;
                Write-Host 'Remote cleanup complete.';
            "