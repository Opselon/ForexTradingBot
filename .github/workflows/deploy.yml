# ====================================================================================
# FINAL GUARANTEED v3: Wrapper Script Method
# This method creates a .bat file on the server that sets environment variables
# and then runs the app, bypassing all process inheritance issues.
# ====================================================================================

name: '🚀 [PROD] Deploy ForexTradingBot'

on:
  push:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: production-deploy
  cancel-in-progress: true

env:
  DOTNET_VERSION: '9.0.x'
  PROJECT_PATH: './WebAPI/WebAPI.csproj'
  REMOTE_DEPLOY_PATH: 'C:\Apps\ForexTradingBot'
  REMOTE_TEMP_PATH: 'C:\Apps\Temp'

jobs:
  # ... (Job 'build' remains the same) ...
  build:
    name: '✅ 1. Build & Package'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: '⚙️ Setup .NET SDK'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - name: '📦 Publish Self-Contained App'
        run: dotnet publish ${{ env.PROJECT_PATH }} -c Release -r win-x64 -o ./publish --self-contained true
      - name: '🗜️ Create ZIP Archive'
        run: cd ./publish && zip -r ../release.zip .
      - name: '📤 Upload Release Artifact'
        uses: actions/upload-artifact@v4
        with:
          name: forex-bot-release-package
          path: release.zip
          retention-days: 1

  deploy:
    name: '🚢 2. Deploy to Production VPS'
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: '📥 Download Release Artifact'
        uses: actions/download-artifact@v4
        with:
          name: forex-bot-release-package

      - name: '📤 Upload Release ZIP to Server'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PROD_SERVER_IP }}
          username: ${{ secrets.PROD_SERVER_USERNAME }}
          password: ${{ secrets.PROD_SERVER_PASSWORD }}
          source: "release.zip"
          target: "${{ env.REMOTE_TEMP_PATH }}"
      
      - name: '▶️ Execute Remote Deployment'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_SERVER_IP }}
          username: ${{ secrets.PROD_SERVER_USERNAME }}
          password: ${{ secrets.PROD_SERVER_PASSWORD }}
          script: |
            # Step 1: Stop any existing process
            taskkill /IM WebAPI.exe /F 2>nul || echo No process to kill.
            
            # Step 2: Clean directory
            powershell -Command "Get-ChildItem -Path '${{ env.REMOTE_DEPLOY_PATH }}' -Exclude 'Session' | Remove-Item -Recurse -Force"
            
            # Step 3: Unpack
            powershell -Command "Expand-Archive -Path '${{ env.REMOTE_TEMP_PATH }}\release.zip' -DestinationPath '${{ env.REMOTE_DEPLOY_PATH }}' -Force"
            
            # Step 4: Create the launcher batch file
            # We use CMD's echo to create the file, which is very robust.
            (
              echo @echo off
              echo echo Setting environment variables...
              echo set ASPNETCORE_ENVIRONMENT=Production
              echo set ConnectionStrings__DefaultConnection=${{ secrets.PROD_CONNECTION_STRING }}
              echo set DatabaseSettings__DatabaseProvider=SqlServer
              echo set TelegramPanel__BotToken=${{ secrets.PROD_TELEGRAM_BOT_TOKEN }}
              echo set TelegramUserApi__ApiId=${{ secrets.TELEGRAM_API_ID }}
              echo set TelegramUserApi__ApiHash=${{ secrets.TELEGRAM_API_HASH }}
              echo set TelegramUserApi__PhoneNumber=${{ secrets.PROD_TELEGRAM_PHONE_NUMBER }}
              echo set CryptoPay__ApiToken=${{ secrets.PROD_CRYPTOPAY_API_TOKEN }}
              echo.
              echo echo Starting WebAPI...
              echo cd /d "${{ env.REMOTE_DEPLOY_PATH }}"
              echo start "" "WebAPI.exe"
            ) > "${{ env.REMOTE_DEPLOY_PATH }}\start-app.bat"
            
            # Step 5: Execute the launcher batch file
            echo Executing the launcher...
            "${{ env.REMOTE_DEPLOY_PATH }}\start-app.bat"
            
            # Step 6: Wait and verify if the process is running
            echo Waiting for 5 seconds...
            timeout /t 5
            tasklist /FI "IMAGENAME eq WebAPI.exe" | find "WebAPI.exe"
            if %errorlevel% neq 0 (
              echo ERROR: WebAPI.exe is not running after start!
              exit 1
            )
            echo SUCCESS: WebAPI.exe is running.
            
            # Step 7: Cleanup
            del "${{ env.REMOTE_TEMP_PATH }}\release.zip"