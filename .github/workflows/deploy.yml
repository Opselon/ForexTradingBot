# ====================================================================================
# THE ABSOLUTELY FINAL, CORRECTED AND GUARANTEED WORKFLOW
# This version fixes the file path issue caused by a misunderstanding of how
# download-artifact works. It uses the simplest, most direct paths possible.
# ====================================================================================

name: 'üöÄ [PROD] Deploy ForexTradingBot'

on:
  push:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: production-deploy
  cancel-in-progress: true

env:
  DOTNET_VERSION: '9.0.x'
  PROJECT_PATH: './WebAPI/WebAPI.csproj'
  REMOTE_TEMP_PATH: 'C:\Apps\Temp'
  # IMPORTANT: This path MUST match the location of your script in the repository
  SCRIPT_PATH_IN_REPO: 'deployment/Deploy-And-Debug.ps1'
  SCRIPT_FILE_NAME: 'Deploy-And-Debug.ps1' # Just the filename, for clarity

jobs:
  build:
    name: '‚úÖ 1. Build & Package'
    runs-on: ubuntu-latest
    steps:
      - name: 'üì• Checkout Repository'
        uses: actions/checkout@v4

      - name: '‚öôÔ∏è Setup .NET SDK'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: 'üì¶ Publish App'
        run: dotnet publish ${{ env.PROJECT_PATH }} -c Release -r win-x64 -o ./publish --self-contained true

      - name: 'üóúÔ∏è Create ZIP Archive'
        run: cd ./publish && zip -r ../release.zip .
      
      - name: 'üì§ Upload Artifacts (App ZIP + Deploy Script)'
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: |
            release.zip
            ${{ env.SCRIPT_PATH_IN_REPO }} # We upload the script from its original location
          retention-days: 1

  deploy:
    name: 'üö¢ 2. Deploy to Production VPS'
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: 'üì• Download All Artifacts to Root'
        uses: actions/download-artifact@v4
        with:
          name: deployment-package
          # This ensures all files are in the root of the workspace

      # For debugging, let's see what files we have after download
      - name: 'üîç Verify Downloaded Files'
        run: ls -R

      - name: 'üì§ Upload Release ZIP to Server'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PROD_SERVER_IP }}
          username: ${{ secrets.PROD_SERVER_USERNAME }}
          password: ${{ secrets.PROD_SERVER_PASSWORD }}
          source: "release.zip"
          target: "${{ env.REMOTE_TEMP_PATH }}"
          
      - name: 'üì§ Upload Deployment Script to Server'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PROD_SERVER_IP }}
          username: ${{ secrets.PROD_SERVER_USERNAME }}
          password: ${{ secrets.PROD_SERVER_PASSWORD }}
          # ‚úÖ‚úÖ‚úÖ THE CRITICAL FIX IS HERE ‚úÖ‚úÖ‚úÖ
          # We now use JUST THE FILENAME, because download-artifact placed it in the root.
          source: ${{ env.SCRIPT_FILE_NAME }}
          target: "${{ env.REMOTE_TEMP_PATH }}"
      
      - name: '‚ñ∂Ô∏è Execute Remote Deployment'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_SERVER_IP }}
          username: ${{ secrets.PROD_SERVER_USERNAME }}
          password: ${{ secrets.PROD_SERVER_PASSWORD }}
          script: |
            powershell.exe -NoProfile -ExecutionPolicy Bypass -File "${{ env.REMOTE_TEMP_PATH }}\${{ env.SCRIPT_FILE_NAME }}" -ConnectionString "${{ secrets.PROD_CONNECTION_STRING }}" -TelegramBotToken "${{ secrets.PROD_TELEGRAM_BOT_TOKEN }}" -TelegramApiId "${{ secrets.TELEGRAM_API_ID }}" -TelegramApiHash "${{ secrets.TELEGRAM_API_HASH }}" -TelegramPhoneNumber "${{ secrets.PROD_TELEGRAM_PHONE_NUMBER }}" -CryptoPayApiToken "${{ secrets.PROD_CRYPTOPAY_API_TOKEN }}"
            del "${{ env.REMOTE_TEMP_PATH }}\${{ env.SCRIPT_FILE_NAME }}"