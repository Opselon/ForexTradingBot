name: ðŸ›¡ï¸ GGShield Scan on Push

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request: # Ø§Ø³Ú©Ù† Ø±ÙˆÛŒ Pull Request Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø²ÙˆØ¯Ù‡Ù†Ú¯Ø§Ù… Ø±Ø§Ø²Ù‡Ø§
    branches:
      - main
      - master
      - develop

jobs:
  ggshield-secret-scan:
    name: ðŸ•µï¸ Run GGShield Secret Scan
    runs-on: ubuntu-latest

    # Ú©Ù„ÛŒØ¯ API Ú¯ÛŒØªâ€ŒÚ¯Ø§Ø±Ø¯ÛŒÙ† Ø±Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† ÛŒÚ© Ù…ØªØºÛŒØ± Ù…Ø­ÛŒØ·ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ù„ Job ØªÙ†Ø¸ÛŒÙ… Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
    # ggshield Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø§ÛŒÙ† Ù…ØªØºÛŒØ± Ù…Ø­ÛŒØ·ÛŒ Ø±Ø§ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ùˆ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø®ÙˆØ§Ù‡Ø¯ Ú©Ø±Ø¯.
    env:
      GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}

    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4 # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² v4 Ø¨Ø±Ø§ÛŒ Ø¢Ø®Ø±ÛŒÙ† ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ Ùˆ Ø§Ù…Ù†ÛŒØª

      - name: ðŸ Set up Python Environment
        uses: actions/setup-python@v5 # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² v5 Ø¨Ø±Ø§ÛŒ Ø¢Ø®Ø±ÛŒÙ† ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ Ùˆ Ø§Ù…Ù†ÛŒØª
        with:
          python-version: '3.x' # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡ Ù¾Ø§ÛŒØ¯Ø§Ø± 3.x
          # 'cache: pip' Ø­Ø°Ù Ø´Ø¯ Ø²ÛŒØ±Ø§ Ù…Ø®Ø²Ù† Ø´Ù…Ø§ Ø§Ø­ØªÙ…Ø§Ù„Ø§ ÙØ§ÛŒÙ„ requirements.txt ÛŒØ§ pyproject.toml Ø¯Ø± Ø±ÛŒØ´Ù‡ Ù†Ø¯Ø§Ø±Ø¯
          # Ú©Ù‡ Ø¨Ø§Ø¹Ø« Ø®Ø·Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ Ù…ÛŒâ€ŒØ´Ø¯. Ø¨Ø±Ø§ÛŒ Ù†ØµØ¨ ÙÙ‚Ø· ggshieldØŒ Ú©Ø´â€ŒÚ©Ø±Ø¯Ù† Ø­ÛŒØ§ØªÛŒ Ù†ÛŒØ³Øª.

      - name: ðŸ“¦ Install ggshield
        run: |
          echo "Installing ggshield..."
          pip install ggshield
          echo "ggshield installed successfully."
          echo "ggshield version: $(ggshield --version)" # Ù†Ù…Ø§ÛŒØ´ Ù†Ø³Ø®Ù‡ ggshield

      - name: ðŸ”Ž Run ggshield Secret Scan on Repository (Show All Secrets)
        run: |
          echo "Starting ggshield secret scan..."
          # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² --all-secrets Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ØªÙ…Ø§Ù… Ø±Ø§Ø²Ù‡Ø§ÛŒ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯Ù‡ØŒ Ø­ØªÛŒ Ø¢Ù†â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.
          # Ø§ÛŒÙ† Ø¨Ø§Ø¹Ø« Ù…ÛŒâ€ŒØ´ÙˆØ¯ ggshield Ø®Ø·Ø§ÛŒ ÙˆØ§Ø¶Ø­â€ŒØªØ±ÛŒ Ø¯Ù‡Ø¯ Ùˆ Ù¾Ø§ÛŒÙ¾â€ŒÙ„Ø§ÛŒÙ† Ø±Ø§ Ø¨Ø§ Ø´Ú©Ø³Øª Ù…ÙˆØ§Ø¬Ù‡ Ú©Ù†Ø¯.
          ggshield secret scan repo . --all-secrets
          echo "ggshield secret scan completed without immediate failure check."
        # Ø§Ú¯Ø± ggshield Ø±Ø§Ø²Ù‡Ø§ÛŒÛŒ Ù¾ÛŒØ¯Ø§ Ú©Ù†Ø¯ØŒ Ø¨Ø§ ÛŒÚ© Ú©Ø¯ Ø®Ø±ÙˆØ¬ ØºÛŒØ±ØµÙØ± (Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ 1) Ø§Ø² Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø®Ø§Ø±Ø¬ Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ
        # Ú©Ù‡ Ø¨Ø§Ø¹Ø« Ø´Ú©Ø³Øª Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡ (Ùˆ Ø¯Ø± Ù†ØªÛŒØ¬Ù‡ Ú©Ù„ Job) Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.
        # Ø§ÛŒÙ† Ø±ÙØªØ§Ø± Ù…Ø·Ù„ÙˆØ¨ Ø¨Ø±Ø§ÛŒ Ù†Ø´Ø§Ù† Ø¯Ø§Ø¯Ù† Ù†Ø´Øª Ø±Ø§Ø² Ø§Ø³Øª.
        # Ù‡ÛŒÚ† "Ø®ÙˆØ¯Ú©Ø§Ø±-Ø±ÙØ¹" Ø¯Ø± Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡ Ø§Ù†Ø¬Ø§Ù… Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯Ø› ÙÙ‚Ø· Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ùˆ Ù‡Ø´Ø¯Ø§Ø±.

      # Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¯Ø± Ù…ÙˆØ±Ø¯ ÙˆØ¶Ø¹ÛŒØª Ø§Ø³Ú©Ù† Ø§Ø³ØªØŒ Ú†Ù‡ Ù…ÙˆÙÙ‚ Ø¨Ø§Ø´Ø¯ Ú†Ù‡ Ù†Ø§Ù…ÙˆÙÙ‚
      - name: ðŸ”” Scan Status Notification
        if: always() # Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡ Ù‡Ù…ÛŒØ´Ù‡ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ Ø­ØªÛŒ Ø§Ú¯Ø± Ø§Ø³Ú©Ù† Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨Ø§Ø´Ø¯
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… GGShield scan completed successfully. No secrets detected in the current push/PR."
            echo "You can merge this code securely."
          else
            echo "âŒ GGShield scan FAILED: Secrets detected or an error occurred!"
            echo "--------------------------------------------------------"
            echo "ACTION REQUIRED: A secret was found in your repository or commit history."
            echo "Please review the logs above for details (look for 'Secret detected' messages)."
            echo "You MUST remediate these secrets MANUALLY. Here's what to do:"
            echo "1. NEVER commit secrets directly to your repository."
            echo "2. If a .env file is involved, add it to your .gitignore."
            echo "3. Go to your GitGuardian dashboard (https://dashboard.gitguardian.com/incidents) to see details of the detected incidents."
            echo "4. Rotate (change) the compromised secret immediately (e.g., get a new Telegram bot token)."
            echo "5. Remove the secret from your Git history (this is a manual, advanced git operation like 'git filter-repo')."
            echo "   (Search 'GitGuardian secret remediation' for detailed steps)."
            echo "6. Store secrets securely as GitHub Repository Secrets (Settings -> Secrets and variables -> Actions)."
            echo "7. Update your application to read secrets from environment variables, not hardcoded in files."
            echo "8. Consider using Git pre-commit hooks to catch secrets locally before pushing."
            echo "--------------------------------------------------------"
            echo "This workflow will continue to fail until the secrets are removed from your repository's history."
          fi