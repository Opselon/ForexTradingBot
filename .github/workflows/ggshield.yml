name: ðŸ›¡ï¸ GGShield Scan on Push

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request: # Ø§Ø³Ú©Ù† Ø±ÙˆÛŒ Pull Request Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø²ÙˆØ¯Ù‡Ù†Ú¯Ø§Ù… Ø±Ø§Ø²Ù‡Ø§
    branches:
      - main
      - master
      - develop

jobs:
  ggshield-secret-scan:
    name: ðŸ•µï¸ Run GGShield Secret Scan
    runs-on: ubuntu-latest

    # Ú©Ù„ÛŒØ¯ API Ú¯ÛŒØªâ€ŒÚ¯Ø§Ø±Ø¯ÛŒÙ† Ø±Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† ÛŒÚ© Ù…ØªØºÛŒØ± Ù…Ø­ÛŒØ·ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ù„ Job ØªÙ†Ø¸ÛŒÙ… Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
    # ggshield Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø§ÛŒÙ† Ù…ØªØºÛŒØ± Ù…Ø­ÛŒØ·ÛŒ Ø±Ø§ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ùˆ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø®ÙˆØ§Ù‡Ø¯ Ú©Ø±Ø¯.
    env:
      GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}

    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4 # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² v4 Ø¨Ø±Ø§ÛŒ Ø¢Ø®Ø±ÛŒÙ† ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ Ùˆ Ø§Ù…Ù†ÛŒØª

      - name: ðŸ Set up Python Environment
        uses: actions/setup-python@v5 # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² v5 Ø¨Ø±Ø§ÛŒ Ø¢Ø®Ø±ÛŒÙ† ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ Ùˆ Ø§Ù…Ù†ÛŒØª
        with:
          python-version: '3.x' # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡ Ù¾Ø§ÛŒØ¯Ø§Ø± 3.x
          # 'cache: pip' Ø­Ø°Ù Ø´Ø¯ Ø²ÛŒØ±Ø§ Ù…Ø®Ø²Ù† Ø´Ù…Ø§ Ø§Ø­ØªÙ…Ø§Ù„Ø§ ÙØ§ÛŒÙ„ requirements.txt ÛŒØ§ pyproject.toml Ø¯Ø± Ø±ÛŒØ´Ù‡ Ù†Ø¯Ø§Ø±Ø¯
          # Ú©Ù‡ Ø¨Ø§Ø¹Ø« Ø®Ø·Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ Ù…ÛŒâ€ŒØ´Ø¯. Ø¨Ø±Ø§ÛŒ Ù†ØµØ¨ ÙÙ‚Ø· ggshieldØŒ Ú©Ø´â€ŒÚ©Ø±Ø¯Ù† Ø­ÛŒØ§ØªÛŒ Ù†ÛŒØ³Øª.

      - name: ðŸ“¦ Install pre-commit and ggshield
        run: |
          echo "Installing pre-commit..."
          pip install pre-commit
          echo "pre-commit installed successfully."
          echo "Running pre-commit install to set up hooks for CI environment..."
          pre-commit install-hooks # Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ù‡ÙˆÚ©â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù…Ø­ÛŒØ· CI ØªÙ†Ø¸ÛŒÙ… Ù…ÛŒâ€ŒÚ©Ù†Ø¯
          echo "pre-commit hooks installed for CI."
          echo "ggshield version: $(ggshield --version)" # Ù†Ù…Ø§ÛŒØ´ Ù†Ø³Ø®Ù‡ ggshield

      - name: ðŸ”Ž Run ggshield Secret Scan via pre-commit (Show All Secrets)
        # Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡ ggshield Ø±Ø§ Ø§Ø² Ø·Ø±ÛŒÙ‚ pre-commit Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
        # Ø§ÛŒÙ† Ù‡Ù…Ø§Ù† Ù‡ÙˆÚ©ÛŒ Ø§Ø³Øª Ú©Ù‡ ØªÙˆØ³Ø¹Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ú¯Ø§Ù† Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ ØµÙˆØ±Øª Ù…Ø­Ù„ÛŒ Ù†ØµØ¨ Ú©Ù†Ù†Ø¯.
        run: |
          echo "Starting ggshield secret scan via pre-commit..."
          # 'pre-commit run --all-files' ØªÙ…Ø§Ù… Ù‡ÙˆÚ©â€ŒÙ‡Ø§ Ø±Ø§ Ø±ÙˆÛŒ ØªÙ…Ø§Ù… ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
          # Ø¢Ø±Ú¯ÙˆÙ…Ø§Ù† Ù‡Ø§ Ø±Ø§ Ù…ÛŒ ØªÙˆØ§Ù†ÛŒØ¯ Ø¯Ø± .pre-commit-config.yaml ÛŒØ§ Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.
          # Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ ggshield Ù‡Ù…Ù‡ Ø±Ø§Ø²Ù‡Ø§ Ø±Ø§ Ù†Ø´Ø§Ù† Ø¯Ù‡Ø¯ØŒ Ø§Ø² --hook-arg --all-secrets Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒ Ú©Ù†ÛŒÙ….
          pre-commit run ggshield --all-files --hook-arg --all-secrets
          echo "ggshield secret scan completed without immediate failure check."
        # Ø§Ú¯Ø± ggshield Ø±Ø§Ø²Ù‡Ø§ÛŒÛŒ Ù¾ÛŒØ¯Ø§ Ú©Ù†Ø¯ØŒ pre-commit Ø¨Ø§ Ú©Ø¯ Ø®Ø±ÙˆØ¬ ØºÛŒØ±ØµÙØ± Ø®Ø§Ø±Ø¬ Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ
        # Ú©Ù‡ Ø¨Ø§Ø¹Ø« Ø´Ú©Ø³Øª Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡ (Ùˆ Ø¯Ø± Ù†ØªÛŒØ¬Ù‡ Ú©Ù„ Job) Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.

      # Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¯Ø± Ù…ÙˆØ±Ø¯ ÙˆØ¶Ø¹ÛŒØª Ø§Ø³Ú©Ù† Ø§Ø³ØªØŒ Ú†Ù‡ Ù…ÙˆÙÙ‚ Ø¨Ø§Ø´Ø¯ Ú†Ù‡ Ù†Ø§Ù…ÙˆÙÙ‚
      - name: ðŸ”” Scan Status Notification & Remediation Guidance
        if: always() # Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡ Ù‡Ù…ÛŒØ´Ù‡ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ Ø­ØªÛŒ Ø§Ú¯Ø± Ø§Ø³Ú©Ù† Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨Ø§Ø´Ø¯
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… GGShield scan completed successfully. No new secrets detected in this push/PR."
            echo "Your code is clean for secrets."
          else
            echo "âŒ GGShield scan FAILED: Secrets were detected in your repository!"
            echo "--------------------------------------------------------"
            echo "IMMEDIATE ACTION REQUIRED: Sensitive secrets were found in your code or Git history."
            echo "Please review the detailed logs above for specifics (look for 'Secret detected' messages)."
            echo "Even 'Ignored' secrets are a security risk if they are in your repository history."
            echo ""
            echo "To resolve this critical issue, you MUST take the following manual steps:"
            echo "1. Rotate the compromised secrets: Immediately change/invalidate the detected tokens (e.g., get new Telegram Bot Tokens, update passwords)."
            echo "2. Clean your Git history: Permanently remove the secrets from ALL past commits where they appear."
            echo "   - This is an advanced Git operation. Search for 'GitGuardian secret remediation' or 'git filter-repo' for detailed, safe instructions."
            echo "   - Example: git filter-repo --path .env --force (this will remove .env from all history)"
            echo "   - After cleaning history, you will need to 'git push --force' (use with extreme caution in shared repos)."
            echo "3. Update your local code: Remove hardcoded secrets from files like .env and appsettings.json."
            echo "   - For .env files: Add '.env' to your .gitignore immediately: 'echo .env >> .gitignore'."
            echo "4. Store secrets securely: Use GitHub Repository Secrets (Settings -> Secrets and variables -> Actions) to store your new tokens/passwords."
            echo "5. Update your application: Modify your application's code to read these secrets from environment variables (e.g., os.environ in Python, or configuration providers in .NET) instead of directly from files."
            echo "6. IMPORTANT FOR LOCAL DEVELOPMENT: Install pre-commit hooks locally to prevent future leaks!"
            echo "   - On your local machine, navigate to your repository root and run:"
            echo "     pip install pre-commit"
            echo "     pre-commit install"
            echo "   - This will scan your code *before* you commit, preventing secrets from entering your Git history."
            echo "--------------------------------------------------------"
            echo "This workflow will continue to fail until ALL secrets are removed from your repository's history."
          fi